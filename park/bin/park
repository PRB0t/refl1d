#!/usr/bin/env python

import sys; sys.path.append('../..')

import json
import base64

from park.client import default_server

USAGE = """\
usage: park cmd1 arg1a arg1b cmd2 arg2 ...

help
    print this message
jobs
    show contents of queue
result jobid
    show result of jobid
stored jobid
    show all keys associated with jobid
fetch jobid key
    retrieve data associated with key (usually 'result')
store jobid key file
    store data from file in key for jobid
stop jobid
    stop running job
delete jobid
    stop running job and remove all data
"""

def main():
    server = default_server()
    i = 1
    while i < len(sys.argv):
        if sys.argv[i] == 'help':
            print USAGE
            break
        elif sys.argv[i] == 'jobs':
            print server.jobs()
            i += 1
        elif sys.argv[i] == 'stop':
            server.cancel(sys.argv[i+1])
            i += 2
        elif sys.argv[i] == 'delete':
            server.delete(sys.argv[i+1])
            i += 2
        elif sys.argv[i] == 'stored':
            print "\n".join(server.stored(sys.argv[i+1]))
            i += 2
        elif sys.argv[i] == 'store':
            fid = open(sys.argv[i+3], 'rb')
            data = fid.read()
            fid.close()
            server.store(sys.argv[i+1],sys.argv[i+2],base64.b64encode(data))
            i += 4
        elif sys.argv[i] == 'fetch':
            data = server.fetch(sys.argv[i+1],sys.argv[i+2])
            print data
            i += 3
        elif sys.argv[i] == 'result':
            data = server.fetch(sys.argv[i+1],'result')
            print json.loads(data)
            i += 2
        else:
            raise ValueError("unknown command "+sys.argv[i])
        

if __name__ == "__main__":
    main()
